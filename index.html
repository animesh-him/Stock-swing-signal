<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Indian Swing Trader — Top Pick + Buy Strength</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#fbfbfd;--card:#fff;--muted:#475569;--accent:#0ea5a4}
    body{font-family:Inter,system-ui,Arial;margin:12px;background:var(--bg);color:#0f172a}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:20px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}
    select,input,button,textarea{padding:8px;border-radius:8px;border:1px solid #e6eef6}
    button{background:var(--accent);color:white;border:none;cursor:pointer}
    #card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.06);margin-top:12px}
    #summary{margin-top:10px;color:var(--muted)}
    #msg{margin-top:10px;color:#b91c1c}
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn-ghost{background:#eef2f7;color:#0f172a}
    @media (max-width:720px){ canvas{height:320px!important} .row{gap:6px} }
    pre{white-space:pre-wrap;background:#0b1220;color:#cbd5e1;padding:10px;border-radius:6px;margin-top:8px}
    /* Top pick gold + blink */
    .top-pick { background: linear-gradient(180deg,#fff9e6,#fff4d1); border: 2px solid #f59e0b; padding:8px; border-radius:8px; box-shadow:0 6px 18px rgba(245,158,11,0.12); }
    .blink { animation: blinkAnim 1.2s ease-in-out infinite; }
    @keyframes blinkAnim { 0% { box-shadow: 0 0 0 0 rgba(245,158,11,0.6);} 50% { box-shadow: 0 0 24px 6px rgba(245,158,11,0.12);} 100% { box-shadow: 0 0 0 0 rgba(245,158,11,0.0);} }
    .top-row { display:flex; gap:12px; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .top-card { padding:10px; border-radius:8px; background:#fff; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:6px;border-bottom:1px solid #eef2f7;text-align:left}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Indian Swing Trader — Top Pick + Buy Strength</h1>
      <div class="small">Auto-selects Top Pick (highest upside). Use blink toggle to disable gold blinking. Proxy: api.allorigins.win</div>
    </div>
    <div style="margin-left:auto" class="small">Default: <strong>TATASTEEL.NS</strong></div>
  </header>  <!-- Controls -->  <div class="row controls">
    <label class="small">Symbol</label>
    <select id="symbol"></select><label class="small">Timeframe</label>
<select id="tf"><option value="1d">Daily</option><option value="1wk">Weekly</option><option value="1mo">Monthly</option></select>

<button id="analyzeBtn">Analyze</button>
<button id="computeTopBtn" class="btn-ghost">Compute Top Pick</button>

<label class="small">Ignore low volume below</label>
<input id="minVol" type="number" value="200000" style="width:110px" />

<label class="small">Auto refresh</label>
<input id="autoChk" type="checkbox" checked />
<label class="small">Interval (sec)</label>
<input id="intervalSec" type="number" value="10" style="width:80px" min="5" />

<button id="blinkToggle" class="btn-ghost">Blink: ON</button>

  </div>  <!-- Top pick row -->  <div class="top-row">
    <div id="topPickCard" class="top-card">
      <div id="topPickTitle" style="font-weight:700">Top Pick: —</div>
      <div id="topPickDetails" class="small">No pick yet</div>
      <div id="blinkStatus" class="small" style="margin-top:6px;color:#92400e">Blinking ON</div>
    </div><div style="flex:1" id="compareCard" class="top-card">
  <div style="font-weight:700">Compare (All Stocks)</div>
  <div id="compareOut" class="small">—</div>
</div>

  </div>  <!-- Main card -->  <div id="card">
    <canvas id="chart" style="width:100%;height:420px"></canvas>
    <div id="summary" class="small">No analysis yet.</div>
    <div id="msg"></div><div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
  <button id="refreshBtn" class="btn-ghost">Refresh Now</button>
  <button id="exportPNG">Export PNG</button>
  <button id="exportCSV">Export CSV</button>
  <button id="runBacktest" class="btn-ghost">Backtest</button>
  <input id="tgWebhook" placeholder="Telegram webhook (optional)" style="flex:1;min-width:200px;padding:8px;border-radius:8px;border:1px solid #e6eef6" />
  <button id="tgTest">Test Alert</button>
</div>

<div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
  <div style="flex:1">
    <h4 style="margin:4px 0">Position Sizer</h4>
    <div class="small">Account: <input id="acctVal" type="number" value="100000" style="width:120px" /></div>
    <div class="small">Risk %: <input id="riskPct" type="number" value="1" style="width:80px" /></div>
    <div style="margin-top:8px"><button id="calcPos">Calc Size</button></div>
    <pre id="posOut" style="height:90px;overflow:auto">—</pre>
  </div>

  <div style="width:360px">
    <h4 style="margin:4px 0">Scanner</h4>
    <textarea id="scanList" style="width:100%;height:120px">TATASTEEL.NS

TATAMOTORS.NS ONGC.NS CDSL.NS RELIANCE.NS HDFCBANK.NS ICICIBANK.NS INFY.NS TCS.NS SBIN.NS ADANIPORTS.NS POWERGRID.NS BHARTIARTL.NS</textarea> <div style="margin-top:8px"><button id="runScan">Run Scan</button></div> <div id="scanOut" class="small" style="max-height:180px;overflow:auto"></div> </div> </div>

<div id="backtestOut" style="margin-top:12px"></div>

  </div><script>
/* ---------- Configuration ---------- */
const SYMBOLS = [
  { sym: 'TATASTEEL.NS', label:'Tata Steel' },
  { sym: 'TATAMOTORS.NS', label:'Tata Motors' },
  { sym: 'ONGC.NS', label:'ONGC' },
  { sym: 'CDSL.NS', label:'CDSL' },
  { sym: 'RELIANCE.NS', label:'Reliance' },
  { sym: 'HDFCBANK.NS', label:'HDFC Bank' },
  { sym: 'ICICIBANK.NS', label:'ICICI Bank' },
  { sym: 'INFY.NS', label:'Infosys' },
  { sym: 'TCS.NS', label:'TCS' },
  { sym: 'SBIN.NS', label:'SBI' },
  { sym: 'ADANIPORTS.NS', label:'Adani Ports' },
  { sym: 'POWERGRID.NS', label:'PowerGrid' },
  { sym: 'BHARTIARTL.NS', label:'Bharti Airtel' }
];
const DEFAULT = 'TATASTEEL.NS';
const PROXY = 'https://api.allorigins.win/raw?url='; // public relay proxy

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
function fmt(n){ return (typeof n === 'number') ? n.toFixed(2) : n; }
function showMsg(t){ $('msg').textContent = t || ''; console.debug('MSG:', t); }

/* ---------- Populate symbols ---------- */
function populateSymbols(){
  const sel = $('symbol'); sel.innerHTML = '';
  SYMBOLS.forEach(s=>{
    const opt = document.createElement('option'); opt.value = s.sym; opt.text = s.label + ' (' + s.sym.replace('.NS','') + ')';
    if(s.sym === DEFAULT) opt.style.fontWeight = '700'; sel.appendChild(opt);
  });
  sel.value = localStorage.getItem('lastSym') || DEFAULT;
}
populateSymbols();

/* ---------- Yahoo via proxy ---------- */
async function fetchYahoo(symbol, range='6mo', interval='1d'){
  const yahoo = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${range}&interval=${interval}`;
  const url = PROXY + encodeURIComponent(yahoo);
  const res = await fetch(url);
  if(!res.ok) throw new Error('Proxy HTTP ' + res.status);
  const j = await res.json();
  if(!j || !j.chart || !j.chart.result) throw new Error('No data');
  return j.chart.result[0];
}

/* ---------- Indicators ---------- */
function ema(values, period){ const out=[]; const k = 2/(period+1); for(let i=0;i<values.length;i++){ if(i===0) out.push(values[0]); else out.push(values[i]*k + out[i-1]*(1-k)); } for(let i=0;i<period-1 && i<out.length;i++) out[i]=null; return out; }
function macd(prices){ const e12=ema(prices,12), e26=ema(prices,26); const macdLine = prices.map((v,i)=> e12[i]!=null && e26[i]!=null ? e12[i]-e26[i] : null); const signal = ema(macdLine.map(v=>v==null?0:v),9).map((v,i)=> macdLine[i]==null?null:v); return {macdLine, signal}; }

/* ---------- Chart ---------- */
let CHART = null;
function drawChart(labels, close, ema21, ema50, buys=[], sells=[]){
  const ctx = $('chart').getContext('2d'); if(CHART) CHART.destroy();
  const datasets = [{label:'Close', data:close, borderColor:'#ef4444', tension:0.2, pointRadius:0}];
  if(ema21) datasets.push({label:'EMA21', data:ema21, borderColor:'#10b981', pointRadius:0});
  if(ema50) datasets.push({label:'EMA50', data:ema50, borderColor:'#2563eb', pointRadius:0});
  if(buys.length) datasets.push({label:'Buys', data:buys.map(b=>({x:b.date,y:b.price})), showLine:false, pointRadius:6, pointBackgroundColor:'#10b981', parsing:{xAxisKey:'x',yAxisKey:'y'}});
  if(sells.length) datasets.push({label:'Sells', data:sells.map(s=>({x:s.date,y:s.price})), showLine:false, pointRadius:6, pointBackgroundColor:'#ef4444', parsing:{xAxisKey:'x',yAxisKey:'y'}});
  CHART = new Chart(ctx, { type:'line', data:{ labels, datasets }, options:{ interaction:{mode:'index',intersect:false}, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:false}} }});
}

/* ---------- Analyze symbol (returns metrics) ---------- */
async function analyzeSymbol(symbol, tf='1d'){
  const range = (tf==='1d')?'6mo':(tf==='1wk'?'2y':'5y');
  const interval = (tf==='1d')?'1d':(tf==='1wk'?'1wk':'1mo');
  const data = await fetchYahoo(symbol, range, interval);
  const timestamps = (data.timestamp || []).map(t=> new Date(t*1000).toLocaleDateString());
  const q = data.indicators && data.indicators.quote && data.indicators.quote[0];
  if(!q || !q.close) throw new Error('No quote');
  const close = q.close, high = q.high||[], low = q.low||[];
  const ema21 = ema(close,21), ema50 = ema(close,50), m = macd(close);
  const buys = [], sells = [];
  for(let i=1;i<close.length;i++){
    if(ema21[i] && ema21[i-1] && close[i-1] <= ema21[i-1] && close[i] > ema21[i]) buys.push({i, date:timestamps[i], price:close[i]});
    if(ema21[i] && ema21[i-1] && close[i-1] >= ema21[i-1] && close[i] < ema21[i]) sells.push({i, date:timestamps[i], price:close[i]});
  }
  // ATR approx
  let atr = null;
  if(high.length>20 && low.length>20){ const tr=[]; for(let i=1;i<close.length;i++){ const trv = Math.max((high[i]-low[i])||0, Math.abs(high[i]-close[i-1])||0, Math.abs(low[i]-close[i-1])||0); tr.push(trv);} const recent = tr.slice(-14); atr = recent.reduce((a,b)=>a+b,0)/recent.length; }
  const lastIdx = close.length-1; const lastPrice = close[lastIdx]; const atrMult = 2; const stop = atr ? (lastPrice - atr*atrMult) : lastPrice*0.98; const target1 = atr ? (lastPrice + atr*1) : lastPrice*1.02; const target2 = atr ? (lastPrice + atr*2) : lastPrice*1.04;
  return { symbol, timestamps, close, ema21, ema50, buys, sells, atr, lastPrice, stop, target1, target2, mac: m, latestVolume: q.volume ? q.volume[q.volume.length-1] : null };
}

/* ---------- Buy strength score ---------- */
function buyStrengthScore(metrics){
  // score combines upside% (to target2) and momentum (recent MACD hist)
  const upside = metrics.target2 ? ((metrics.target2 - metrics.lastPrice) / metrics.lastPrice) * 100 : 0;
  let macHist = 0; try{ const hist = metrics.mac.hist; if(hist && hist.length>0) macHist = hist[hist.length-1]||0; }catch(e){}
  // normalize macHist roughly (divide by price scale)
  const macNorm = metrics.lastPrice ? (macHist/metrics.lastPrice)*100 : 0;
  // weight upside 0.75, momentum 0.25
  return (0.75 * upside) + (0.25 * macNorm);
}

/* ---------- Compute top pick across all symbols (ignores low volume) ---------- */
async function computeTopPickAll(){
  showMsg('Computing top pick across all symbols — please wait...');
  const tf = $('tf').value;
  const minVol = Number($('minVol').value) || 0;
  const results = [];
  for(const s of SYMBOLS){
    try{
      const r = await analyzeSymbol(s.sym, tf);
      // ignore low volume if requested
      if(minVol>0 && r.latestVolume!=null && r.latestVolume < minVol){ console.log('Skipping low volume', s.sym, r.latestVolume); continue; }
      const upsidePct = r.target2 ? ((r.target2 - r.lastPrice)/r.lastPrice)*100 : 0;
      const downsidePct = r.stop ? ((r.lastPrice - r.stop)/r.lastPrice)*100 : 0;
      const score = buyStrengthScore(r);
      results.push({ sym: s.sym, label: s.label, metrics: r, upside: upsidePct, downside: downsidePct, score });
    }catch(e){ console.warn('skip', s.sym, e.message); }
  }
  if(results.length===0){ showMsg('No symbols passed volume filter or fetch failed.'); return null; }
  // sort by score desc
  results.sort((a,b)=> b.score - a.score);
  // render compare
  $('compareOut').innerHTML = results.map(r=> `${r.label} (${r.sym}): Last ${fmt(r.metrics.lastPrice)} · Upside ${fmt(r.upside)}% · Downside ${fmt(r.downside)}% · Score ${fmt(r.score)}`).slice(0,12).join('<br>');
  const top = results[0];
  highlightTopPick(top);
  showMsg('Top pick computed');
  return top;
}

/* ---------- Highlight top pick and auto-select ---------- */
function highlightTopPick(top){
  if(!top) return;
  const card = $('topPickCard');
  card.className = 'top-card top-pick';
  if(enableBlink) card.classList.add('blink');
  $('topPickTitle').textContent = `Top Pick: ${top.label} (${top.sym.replace('.NS','')})`;
  $('topPickDetails').innerHTML = `Price: <b>${fmt(top.metrics.lastPrice)}</b> · Upside: <b>${fmt(top.upside)}%</b> · Downside est: ${fmt(top.downside)}%<br>Target1: ${fmt(top.metrics.target1)} · Target2: ${fmt(top.metrics.target2)} · Stop: ${fmt(top.metrics.stop)}`;
  // auto-select in dropdown
  $('symbol').value = top.sym;
  localStorage.setItem('lastSym', top.sym);
  // analyze selected to draw chart
  analyzeSelected();
}

/* ---------- Analyze selected symbol and draw chart ---------- */
let LAST = null;
async function analyzeSelected(){
  const sym = $('symbol').value; if(!sym) return; $('summary').textContent = 'Loading...';
  try{
    const r = await analyzeSymbol(sym, $('tf').value);
    drawChart(r.timestamps, r.close, r.ema21, r.ema50, r.buys.slice(-6), r.sells.slice(-6));
    const lastPrice = r.lastPrice; let action = 'HOLD';
    if(r.ema21 && r.ema50 && lastPrice > r.ema21[r.ema21.length-1] && r.ema21[r.ema21.length-1] > r.ema50[r.ema50.length-1]) action='BUY';
    if(lastPrice < r.ema21[r.ema21.length-1]) action='SELL';
    $('summary').innerHTML = `<b>${sym}</b> · Last ${fmt(lastPrice)} · Action: <strong>${action}</strong><br>Targets: ${fmt(r.target1)} / ${fmt(r.target2)} · Stop: ${fmt(r.stop)}${r.atr?` · ATR ${fmt(r.atr)}`:''}`;
    LAST = r; showMsg('');
  }catch(e){ showMsg('Error loading symbol: '+e.message); console.error(e); }
}

/* ---------- Exports, backtest, pos size ---------- */
function exportPNG(){ if(!CHART){ alert('No chart'); return; } const url = $('chart').toDataURL('image/png'); const a = document.createElement('a'); a.href = url; a.download = (LAST?.symbol||'chart') + '.png'; a.click(); }
function exportCSV(){ if(!LAST){ alert('Run analysis first'); return; } const rows = [['date','close','signal']]; for(let i=0;i<LAST.timestamps.length;i++){ let sig=''; if(LAST.buys.find(b=>b.i===i)) sig='BUY'; if(LAST.sells.find(s=>s.i===i)) sig='SELL'; rows.push([LAST.timestamps[i], LAST.close[i], sig]); } const csv = rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('
'); const blob = new Blob([csv],{type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (LAST?.symbol||'signals') + '_signals.csv'; a.click(); }
function calcPos(){ if(!LAST){ alert('Run analysis first'); return; } const acct = Number($('acctVal').value||100000); const riskPct = Number($('riskPct').value||1)/100; const price = LAST.lastPrice; const stop = LAST.stop || price*(1-0.02); const riskPerShare = Math.abs(price - stop); if(riskPerShare<=0){ $('posOut').textContent='Invalid stop/price'; return; } const qty = Math.floor((acct*riskPct)/riskPerShare); $('posOut').textContent = `Price: ${fmt(price)}
Stop: ${fmt(stop)}
Risk/share: ${fmt(riskPerShare)}
Qty: ${qty}
Notional: ${fmt(qty*price)}`; }

/* ---------- Scanner & Backtest ---------- */
async function runScan(){ const list = $('scanList').value.split(/
?
/).map(s=>s.trim()).filter(Boolean); $('scanOut').textContent = 'Scanning...'; const out=[]; for(const s of list){ try{ const r = await analyzeSymbol(s,'1d'); const last=r.lastPrice; const upside = r.target2 ? ((r.target2-last)/last)*100 : 0; out.push({sym:s,price:last,upside}); }catch(e){ out.push({sym:s,price:null,upside:0}); }} out.sort((a,b)=>b.upside-a.upside); $('scanOut').innerHTML = out.map(x=> `<div><b>${x.sym}</b> — ${x.price?fmt(x.price):'N/A'} — Upside ${fmt(x.upside)}%</div>`).join(''); }
function runBacktest(){ if(!LAST){ alert('Run analysis'); return; } const data=LAST.close, e21=LAST.ema21, e50=LAST.ema50; let cash=100000,pos=0,trades=[]; for(let i=1;i<data.length;i++){ if(e21[i] && e50[i] && e21[i]>e50[i] && data[i]>e21[i] && pos===0){ const atrEst = LAST.atr || Math.abs(LAST.lastPrice - LAST.stop) || data[i]*0.02; const stop = data[i]-atrEst*2; const riskPerShare = data[i]-stop; const qty = Math.floor((cash*0.01)/riskPerShare); if(qty>0){ pos=qty; cash -= qty*data[i]; trades.push({type:'BUY',price:data[i],qty,idx:i,stop}); } } if(pos>0){ const stop = trades[trades.length-1].stop; if(data[i] < stop){ cash += pos*data[i]; trades.push({type:'SELL',price:data[i],qty:pos,idx:i}); pos=0; } } } if(pos>0){ cash += pos * data[data.length-1]; trades.push({type:'SELL',price:data[data.length-1],qty:pos,idx:data.length-1}); pos=0; } const pnl = cash - 100000; $('backtestOut').innerHTML = `<pre>Trades: ${trades.length}
P&L: ${fmt(pnl)}
${JSON.stringify(trades,null,2)}</pre>`; }/* ---------- Telegram test ---------- */ async function testTelegram(){ const w = $('tgWebhook').value.trim(); if(!w) return alert('Paste Telegram webhook'); try{ await fetch(w, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text:Test alert from Swing Lab for ${$('symbol').value}})}); alert('Test sent'); }catch(e){ alert('Alert failed: '+e.message); } }

/* ---------- Blink toggle control ---------- */ let enableBlink = true; function toggleBlink(){ enableBlink = !enableBlink; const btn = $('blinkToggle'); btn.textContent = enableBlink ? 'Blink: ON' : 'Blink: OFF'; const status = $('blinkStatus'); status.textContent = enableBlink ? 'Blinking ON' : 'Blinking OFF'; const card = $('topPickCard'); if(enableBlink) card.classList.add('blink'); else card.classList.remove('blink'); } $('blinkToggle').addEventListener('click', toggleBlink);

/* ---------- Wire UI ---------- */ $('computeTopBtn').addEventListener('click', ()=> computeTopPickAll()); $('analyzeBtn').addEventListener('click', analyzeSelected); $('refreshBtn').addEventListener('click', analyzeSelected); $('exportPNG').addEventListener('click', exportPNG); $('exportCSV').addEventListener('click', exportCSV); $('calcPos').addEventListener('click', calcPos); $('runScan').addEventListener('click', runScan); $('runBacktest').addEventListener('click', runBacktest); $('tgTest').addEventListener('click', testTelegram);

/* ---------- Auto refresh ---------- / let AUTO_TIMER = null; function startAuto(){ if(AUTO_TIMER) clearInterval(AUTO_TIMER); const sec = Math.max(5, Number($('intervalSec').value) || 10); AUTO_TIMER = setInterval(()=> { computeTopPickAll().catch(()=>{}); }, sec1000); $('autoChk').checked = true; } function stopAuto(){ if(AUTO_TIMER) clearInterval(AUTO_TIMER); AUTO_TIMER = null; $('autoChk').checked = false; } $('autoChk').addEventListener('change', (e)=> { if(e.target.checked) startAuto(); else stopAuto(); });

/* ---------- Init on load ---------- / window.addEventListener('load', async ()=>{ populateSymbols(); const saved = localStorage.getItem('lastSym'); if(saved) $('symbol').value = saved; try{ const top = await computeTopPickAll(); if(top){ / already highlighted */ } }catch(e){ console.warn('topPick compute failed on load', e); } if($('autoChk').checked) startAuto(); });

/* ---------- Cleanup ---------- */ window.addEventListener('beforeunload', ()=> stopAuto()); </script>

</body>
</html>
