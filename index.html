<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Indian Swing Trader — Live (.NS)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#ffffff;--muted:#374151;--accent:#059669}
    body{font-family:Inter,system-ui,Arial;margin:12px;background:var(--bg);color:#0f172a}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:20px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}
    select,input,button,textarea{padding:8px;border-radius:8px;border:1px solid #e6eef6}
    button{background:var(--accent);color:white;border:none;cursor:pointer}
    #card{background:white;padding:12px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.06);margin-top:12px}
    #summary{margin-top:10px;color:var(--muted)}
    #msg{margin-top:10px;color:#b91c1c}
    @media (max-width:600px){ canvas{height:300px!important} }
    .small{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{background:#f1f5f9;padding:6px 10px;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Indian Swing Trader — Live (.NS)</h1>
      <div class="small">Auto-refresh every 10s. Default: <strong>TATASTEEL.NS</strong>. Uses public proxy to avoid CORS.</div>
    </div>
    <div style="margin-left:auto" class="small">Streaming: <span id="streamStatus">ON</span></div>
  </header>

  <div class="row controls" style="margin-top:10px">
    <label for="symbol">Symbol</label>
    <select id="symbol" aria-label="symbol"></select>

    <label for="tf">Timeframe</label>
    <select id="tf">
      <option value="1d" selected>Daily</option>
      <option value="1wk">Weekly</option>
      <option value="1mo">Monthly</option>
    </select>

    <button id="analyze">Analyze</button>
    <button id="topPicks">Top Picks</button>
    <div style="margin-left:auto" class="pill small">Live interval: <input id="liveSec" value="10" style="width:60px; margin-left:6px" /> sec</div>
  </div>

  <div id="card">
    <canvas id="chart" style="width:100%;height:420px"></canvas>
    <div id="summary" class="small">No data yet.</div>
    <div id="msg"></div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="exportPNG">Export PNG</button>
      <button id="exportCSV">Export CSV</button>
      <input id="tgWebhook" placeholder="Telegram webhook (optional)" style="flex:1;min-width:200px;padding:8px;border-radius:8px;border:1px solid #e6eef6" />
      <button id="testAlert">Test Alert</button>
    </div>
  </div>

<script>
/* ---------- Configuration ---------- */
const SYMBOLS = [
  "TATASTEEL.NS",
  "TATAMOTORS.NS",
  "ONGC.NS",
  "CDSL.NS",
  "RELIANCE.NS",
  "HDFCBANK.NS",
  "ICICIBANK.NS",
  "INFY.NS",
  "TCS.NS",
  "SBIN.NS",
  "ADANIPORTS.NS",
  "POWERGRID.NS",
  "BHARTIARTL.NS"
];
const DEFAULT = "TATASTEEL.NS";
const ALLORIGINS = "https://api.allorigins.win/raw?url="; // public proxy (no-key)

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const showMsg = (t) => { $('msg').textContent = t || ''; console.debug('MSG:', t); }
function fmt(n){ return (typeof n==='number')? n.toFixed(2) : n; }

/* ---------- UI init ---------- */
function populateSymbols(){
  const sel = $('symbol');
  sel.innerHTML = '';
  for(const s of SYMBOLS){
    const o = document.createElement('option'); o.value = s; o.text = s.replace('.NS','');
    if(s===DEFAULT) o.style.fontWeight='700';
    sel.appendChild(o);
  }
  sel.value = localStorage.getItem('lastSym') || DEFAULT;
}
populateSymbols();

/* ---------- Yahoo fetch via proxy ---------- */
async function fetchYahooProxy(symbol, range='6mo', interval='1d'){
  const base = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${range}&interval=${interval}`;
  const proxyUrl = ALLORIGINS + encodeURIComponent(base);
  const res = await fetch(proxyUrl);
  if(!res.ok) throw new Error(`Proxy HTTP ${res.status}`);
  const j = await res.json();
  if(!j || !j.chart || !j.chart.result) throw new Error('No result from Yahoo');
  return j.chart.result[0];
}

/* ---------- Indicators (simple implementations) ---------- */
function ema(values, period){
  const out=[]; const k = 2/(period+1);
  for(let i=0;i<values.length;i++){
    if(i===0) out.push(values[0]);
    else out.push(values[i]*k + out[i-1]*(1-k));
  }
  for(let i=0;i<period-1 && i<out.length;i++) out[i]=null;
  return out;
}
function sma(values,period){ const out=[]; for(let i=0;i<values.length;i++){ if(i+1<period) out.push(null); else out.push(values.slice(i+1-period,i+1).reduce((a,b)=>a+b,0)/period); } return out; }
function rsi(prices,period=14){ const out=[]; for(let i=0;i<prices.length;i++){ if(i<period) out.push(null); else{ let g=0,l=0; for(let j=i-period+1;j<=i;j++){ const d = prices[j]-prices[j-1]; if(d>0) g+=d; else l+=Math.abs(d);} const avgG=g/period, avgL=l/period; const rs = avgL===0?100:avgG/avgL; out.push(100-(100/(1+rs))); }} return out; }
function macd(prices){ const e12=ema(prices,12), e26=ema(prices,26); const macdLine = prices.map((p,i)=> (e12[i]!=null && e26[i]!=null) ? e12[i]-e26[i] : null); const signal = ema(macdLine.map(v=>v==null?0:v),9).map((v,i)=> macdLine[i]==null?null:v); const hist = macdLine.map((v,i)=> v==null||signal[i]==null?null:v-signal[i]); return {macdLine,signal,hist}; }

/* ---------- Charting ---------- */
let CHART = null;
function drawChart(labels, close, ema21, ema50, buys, sells){
  const ctx = $('chart').getContext('2d');
  if(CHART) CHART.destroy();
  const datasets = [{label:'Close', data:close, borderColor:'#ef4444', tension:0.2, pointRadius:0}];
  if(ema21) datasets.push({label:'EMA21', data:ema21, borderColor:'#10b981', pointRadius:0});
  if(ema50) datasets.push({label:'EMA50', data:ema50, borderColor:'#2563eb', pointRadius:0});
  if(buys && buys.length) datasets.push({label:'Buys', data: buys.map(b=>({x:b.date,y:b.price})), showLine:false, pointRadius:6, pointBackgroundColor:'#10b981', parsing:{xAxisKey:'x',yAxisKey:'y'}});
  if(sells && sells.length) datasets.push({label:'Sells', data: sells.map(s=>({x:s.date,y:s.price})), showLine:false, pointRadius:6, pointBackgroundColor:'#ef4444', parsing:{xAxisKey:'x',yAxisKey:'y'}});
  CHART = new Chart(ctx, { type:'line', data:{ labels, datasets }, options:{ interaction:{mode:'index',intersect:false}, plugins:{legend:{display:true}}, scales:{y:{beginAtZero:false}} } });
}

/* ---------- Analysis core ---------- */
let lastResult = null;
async function analyzeOnce(){
  showMsg('');
  const symbol = $('symbol').value;
  localStorage.setItem('lastSym', symbol);
  const tf = $('tf').value;
  const range = (tf==='1d')?'6mo':(tf==='1wk'?'2y':'5y');
  const interval = (tf==='1d')?'1d':(tf==='1wk'?'1wk':'1mo');
  $('summary').textContent = 'Loading...';
  try{
    const raw = await fetchYahooProxy(symbol, range, interval);
    const timestamps = raw.timestamp || [];
    const q = raw.indicators && raw.indicators.quote && raw.indicators.quote[0];
    if(!q || !q.close) throw new Error('No quote data available');
    const close = q.close;
    const highs = q.high || [];
    const lows = q.low || [];
    const dates = timestamps.map(t=> new Date(t*1000).toLocaleDateString());
    // indicators
    const e21 = ema(close,21), e50 = ema(close,50), rsiA = rsi(close,14), mac = macd(close);
    // buy/sell markers (simple EMA21 breakout)
    const buys = [], sells = [];
    for(let i=1;i<close.length;i++){
      if(e21[i] && e21[i-1] && close[i-1] <= e21[i-1] && close[i] > e21[i]) buys.push({i, date:dates[i], price:close[i]});
      if(e21[i] && e21[i-1] && close[i-1] >= e21[i-1] && close[i] < e21[i]) sells.push({i, date:dates[i], price:close[i]});
    }
    drawChart(dates, close, e21, e50, buys.slice(-6), sells.slice(-6));
    // produce actionable suggestion for last bar
    const lastIdx = close.length-1;
    const lastPrice = close[lastIdx];
    const lastE21 = e21[lastIdx], lastE50 = e50[lastIdx];
    let action = 'HOLD', reasons = [];
    if(lastE21 && lastE50 && lastPrice > lastE21 && lastE21>lastE50) { action='BUY'; reasons.push('Price > EMA21 and EMA21 > EMA50'); }
    if(lastE21 && lastPrice < lastE21) { action='SELL'; reasons.push('Price < EMA21'); }
    if(buys.length && buys[buys.length-1].i === lastIdx) { action='STRONG BUY'; reasons.push('Recent EMA21 breakout'); }
    // compute ATR for stop suggestion (approx via highs/lows)
    let atrVal = null;
    if(highs.length>20 && lows.length>20){
      const tr = [];
      for(let i=1;i<close.length;i++){
        const trv = Math.max( (highs[i]-lows[i])||0, Math.abs(highs[i] - close[i-1])||0, Math.abs(lows[i] - close[i-1])||0 );
        tr.push(trv);
      }
      const recent = tr.slice(-14);
      atrVal = recent.reduce((a,b)=>a+b,0)/recent.length;
    }
    // targets & stop loss
    const atrMult = 2;
    const stop = atrVal ? (lastPrice - atrVal*atrMult) : (lastPrice*0.98);
    const t1 = atrVal ? (lastPrice + atrVal*1) : (lastPrice*1.02);
    const t2 = atrVal ? (lastPrice + atrVal*2) : (lastPrice*1.04);
    $('summary').innerHTML = `<b>${symbol}</b> · Last ${fmt(lastPrice)} · Action: <strong>${action}</strong><br>
      Reasons: ${reasons.join(' · ') || 'None'}<br>
      Targets: ${fmt(t1)} / ${fmt(t2)} · Stop: ${fmt(stop)} ${atrVal?('(ATR '+fmt(atrVal)+')'):''}`;
    lastResult = { symbol, close, dates, buys, sells, lastPrice, stop, t1, t2 };
    showMsg('');
    return lastResult;
  }catch(err){
    console.error('Analyze error', err);
    $('summary').textContent = 'No data';
    showMsg('Error fetching or parsing data: ' + err.message + ' — try Live Server or wait and retry.');
    return null;
  }
}

/* ---------- Live streaming ---------- */
let liveTimer = null;
async function startLive(){
  stopLive();
  const sec = Math.max(5, Number($('liveSec').value) || 10);
  $('streamStatus').textContent = `ON (every ${sec}s)`;
  // immediate run
  await analyzeOnce();
  liveTimer = setInterval(analyzeOnce, sec*1000);
}
function stopLive(){ if(liveTimer) clearInterval(liveTimer); liveTimer = null; $('streamStatus').textContent = 'OFF'; }

/* ---------- Small utilities ---------- */
function exportPNG(){
  if(!CHART) { alert('No chart'); return; }
  const url = $('chart').toDataURL('image/png');
  const a = document.createElement('a'); a.href = url; a.download = (lastResult?.symbol || 'chart') + '.png'; a.click();
}
function exportCSV(){
  if(!lastResult){ alert('Run analysis'); return; }
  const rows = [['date','close','signal']];
  for(let i=0;i<lastResult.dates.length;i++){
    let sig = '';
    if(lastResult.buys.find(b=>b.i===i)) sig='BUY';
    if(lastResult.sells.find(s=>s.i===i)) sig='SELL';
    rows.push([lastResult.dates[i], lastResult.close[i], sig]);
  }
  const csv = rows.map(r=> r.map(c=>`"${c}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (lastResult?.symbol||'signals') + '_signals.csv'; a.click();
}
async function sendTestAlert(){
  const w = $('tgWebhook').value.trim();
  if(!w) return alert('Paste Telegram webhook URL (bot sendMessage URL) to test.');
  try{ await fetch(w, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text: `Test alert from Swing Lab for ${$('symbol').value}`})}); alert('Test sent'); }catch(e){ alert('Alert failed: '+e.message); }
}

/* ---------- Top picks (quick) ---------- */
async function topPicks(){
  showMsg('');
  $('summary').textContent = 'Computing top picks...';
  try{
    const results = [];
    for(const s of SYMBOLS){
      try{
        const r = await fetchYahooProxy(s,'3mo','1d');
        const close = r.indicators.quote[0].close; const last = close[close.length-1];
        results.push({sym:s, last});
      }catch(e){ console.warn('skip', s, e.message); }
    }
    results.sort((a,b)=> ( (b.last||0) - (a.last||0) ));
    $('summary').innerHTML = `<b>Top picks (by latest price):</b><br>` + results.slice(0,6).map(x=>`${x.sym} — ${fmt(x.last)}`).join('<br>');
  }catch(e){ showMsg('Top picks failed: '+e.message); }
}

/* ---------- Wire UI ---------- */
$('analyze').addEventListener('click', () => analyzeOnce());
$('topPicks').addEventListener('click', topPicks);
$('exportPNG').addEventListener('click', exportPNG);
$('exportCSV').addEventListener('click', exportCSV);
$('testAlert').addEventListener('click', sendTestAlert);

/* ---------- Start live on load ---------- */
window.addEventListener('load', () => {
  populateSymbols();
  // auto-run analyze + start live streaming
  startLive().catch(e=>{ console.warn(e); showMsg('Live start error: '+e.message); });
});
</script>
</body>
</html>
